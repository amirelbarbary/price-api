<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>آلة حاسبة لجدول كميات المشاريع - الإصدار المطور</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
            color: #333;
            font-size: 14px;
        }
        .container {
            width: 100%;
            max-width: 1900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom: 5px solid #5a67d8;
        }
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .subtitle {
            font-size: 16px;
            opacity: 0.9;
            font-weight: 300;
        }
        .project-title {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            border-bottom: 2px solid #e9ecef;
        }
        .project-title input {
            flex: 1;
            min-width: 350px;
            padding: 12px 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s;
            background: #fff;
        }
        .project-title input:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .import-btn {
            background: linear-gradient(135deg, #17a2b8, #20c997);
            color: white;
            box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
        }
        .import-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(23, 162, 184, 0.4);
        }
        .export-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }
        .print-btn {
            background: linear-gradient(135deg, #6f42c1, #e83e8c);
            color: white;
            box-shadow: 0 4px 15px rgba(111, 66, 193, 0.3);
        }
        .print-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(111, 66, 193, 0.4);
        }
        .reset-btn {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
            color: white;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }
        .reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        }
        .settings-btn {
            background: linear-gradient(135deg, #fd7e14, #ffc107);
            color: white;
            box-shadow: 0 4px 15px rgba(253, 126, 20, 0.3);
        }
        .settings-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(253, 126, 20, 0.4);
        }
        .calculator {
            padding: 20px;
        }
        .settings-panel {
            background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            font-size: 14px;
            border: 2px solid #dee2e6;
        }
        .settings-panel.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .settings-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .settings-group {
            flex: 1;
            min-width: 250px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .settings-group h3 {
            margin-bottom: 10px;
            color: #495057;
            font-size: 16px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .tax-toggle {
            display: flex;
            align-items: center;
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            padding: 12px 18px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            border: 2px solid #ffc107;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 25px;
            margin: 0 10px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 25px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 19px;
            width: 19px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        input:checked + .slider:before {
            transform: translateX(25px);
        }
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1400px;
            font-size: 13px;
            background: white;
        }
        th, td {
            border: 1px solid #dee2e6;
            padding: 10px 8px;
            text-align: center;
        }
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            font-size: 13px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        tr:nth-child(even) {
            background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);
        }
        tr:hover {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            transform: scale(1.01);
            transition: all 0.2s;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            text-align: center;
            font-size: 13px;
            transition: all 0.3s;
            background: #fff;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        .price-container {
            display: flex;
            gap: 4px;
        }
        .price-input {
            flex: 1;
        }
        .tax-toggle-cell {
            width: 40px;
        }
        .item-tax-toggle {
            width: 40px;
            height: 20px;
        }
        .delete-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
            font-weight: bold;
        }
        .delete-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }
        .total-row {
            font-weight: bold;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
            font-size: 14px;
        }
        .final-summary {
            margin-top: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            font-size: 14px;
        }
        .final-summary-item {
            background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid #ffc107;
            transition: all 0.3s;
        }
        .final-summary-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .final-summary-title {
            font-size: 16px;
            font-weight: bold;
            color: #495057;
        }
        .final-summary-value {
            font-size: 16px;
            font-weight: bold;
            color: #28a745;
            text-align: left;
            min-width: 120px;
        }
        .final-summary-text {
            font-size: 13px;
            color: #6c757d;
            font-style: italic;
            text-align: left;
            min-width: 180px;
            margin-top: 5px;
        }
        .grand-total-item {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
            border: 3px solid #28a745 !important;
            font-size: 18px;
        }
        .text-total-item {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #e2e3e5 0%, #f8f9fa 100%) !important;
            border: 2px solid #6c757d !important;
            text-align: center;
            flex-direction: column;
        }
        .add-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }
        .instructions {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #fff4e6 0%, #ffe8cc 100%);
            border-left: 5px solid #fd7e14;
            border-radius: 8px;
            font-size: 14px;
        }
        .instructions h3 {
            margin-bottom: 10px;
            color: #e8590c;
            font-size: 16px;
        }
        .instructions ul {
            padding-right: 20px;
            line-height: 1.8;
        }
        .instructions li {
            margin-bottom: 8px;
        }
        @media (max-width: 768px) {
            .final-summary {
                grid-template-columns: 1fr;
            }
            .final-summary-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }
        @media print {
            body {
                background: white;
                padding: 0;
            }
            .container {
                box-shadow: none;
                border-radius: 0;
            }
            .action-buttons, .controls, .delete-btn, .import-section, .settings-btn, .instructions {
                display: none !important;
            }
        }
        /* نظام الاقتراحات */
        .suggestions {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            width: 350px;
            display: none;
        }
        .suggestion-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .suggestion-item:hover {
            background: #e9ecef;
        }
        .suggestion-item:last-child {
            border-bottom: none;
        }
        .suggestion-name {
            font-weight: bold;
            color: #333;
        }
        .suggestion-price {
            color: #28a745;
            font-weight: bold;
            min-width: 80px;
            text-align: right;
        }
        .suggestion-range {
            color: #6c757d;
            font-size: 11px;
        }
        .suggestion-source {
            color: #007bff;
            font-size: 11px;
            margin-top: 2px;
        }
        .ai-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>آلة حاسبة لجدول كميات المشاريع</h1>
            <div class="subtitle">الإصدار المطور - مع حساب ضريبة السعر الإفرادي المتقدم</div>
        </header>
        <div class="project-title">
            <input type="text" id="project-name" placeholder="أدخل اسم المشروع هنا">
            <div class="action-buttons">
                <button class="import-btn" id="import-btn">
                    <span>📁</span> استيراد
                </button>
                <button class="export-btn" id="export-btn">
                    <span>💾</span> تصدير
                </button>
                <button class="print-btn" id="print-btn">
                    <span>🖨️</span> طباعة
                </button>
                <button class="settings-btn" id="settings-btn">
                    <span>⚙️</span> الإعدادات
                </button>
                <button class="reset-btn" id="reset">
                    <span>🗑️</span> مسح الكل
                </button>
            </div>
        </div>
        <div class="calculator">
            <div class="settings-panel" id="settings-panel">
                <div class="settings-row">
                    <div class="settings-group">
                        <h3>إعدادات السنوات</h3>
                        <div class="years-control">
                            <label>عدد السنوات:</label>
                            <input type="number" id="years-count" min="1" max="10" value="3">
                            <button id="apply-years">تطبيق</button>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3>إعدادات الضريبة</h3>
                        <div class="tax-settings">
                            <label>نسبة الضريبة:</label>
                            <input type="number" id="tax-rate" min="0" max="100" value="15" step="0.1">
                            <span>%</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="controls">
                <div class="tax-toggle">
                    <span>الضريبة افتراضياً بدون</span>
                    <label class="switch">
                        <input type="checkbox" id="global-tax-toggle">
                        <span class="slider"></span>
                    </label>
                    <span>الضريبة افتراضياً مفعلة</span>
                </div>
                <button class="add-btn" id="add-row">
                    <span>➕</span> إضافة بند جديد
                </button>
            </div>
            <div class="table-container">
                <table id="calculator-table">
                    <thead>
                        <tr>
                            <th width="3%">م</th>
                            <th width="18%">البند</th>
                            <th width="7%">وحدة القياس</th>
                            <th width="8%">الكمية الإجمالية</th>
                            <th width="6%">السنة الأولى</th>
                            <th width="6%">السنة الثانية</th>
                            <th width="6%">السنة الثالثة</th>
                            <th width="9%">السعر الإفرادي</th>
                            <th width="5%">ضريبة</th>
                            <th width="9%">ضريبة السعر الفردي</th>
                            <th width="10%">السعر الإجمالي غير شامل</th>
                            <th width="10%">ضريبة السعر الإجمالي</th>
                            <th width="10%">السعر الإجمالي شامل الضريبة</th>
                            <th width="3%">حذف</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td><input type="text" class="item-name" placeholder="اسم البند"></td>
                            <td>
                                <select class="unit">
                                    <option value="عدد">عدد</option>
                                    <option value="حبة">حبة</option>
                                    <option value="كيلو">كيلو</option>
                                    <option value="لتر">لتر</option>
                                    <option value="متر">متر</option>
                                    <option value="علبة">علبة</option>
                                </select>
                            </td>
                            <td><input type="number" class="quantity" min="0" value="" step="0.01"></td>
                            <td><input type="number" class="year1" min="0" value="" step="0.01"></td>
                            <td><input type="number" class="year2" min="0" value="" step="0.01"></td>
                            <td><input type="number" class="year3" min="0" value="" step="0.01"></td>
                            <td>
                                <input type="number" class="price" min="0" value="0" step="0.01">
                            </td>
                            <td class="tax-toggle-cell">
                                <label class="switch">
                                    <input type="checkbox" class="item-tax-toggle">
                                    <span class="slider"></span>
                                </label>
                            </td>
                            <td class="individual-tax">0.00</td>
                            <td class="total-price-excluding">0.00</td>
                            <td class="total-tax">0.00</td>
                            <td class="total-price-including">0.00</td>
                            <td><button class="delete-btn">X</button></td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="3">المجموع</td>
                            <td id="total-quantity">0.00</td>
                            <td id="year1-total">0.00</td>
                            <td id="year2-total">0.00</td>
                            <td id="year3-total">0.00</td>
                            <td colspan="2">الإجمالي</td>
                            <td id="total-individual-tax">0.00</td>
                            <td id="total-price-excluding">0.00</td>
                            <td id="total-tax">0.00</td>
                            <td id="total-price-including">0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div class="final-summary">
                <div class="final-summary-item">
                    <div>
                        <div class="final-summary-title">إجمالي الكميات:</div>
                        <div class="final-summary-text" id="final-text-quantity">صفر</div>
                    </div>
                    <div class="final-summary-value" id="final-total-quantity">0.00</div>
                </div>
                <div class="final-summary-item">
                    <div>
                        <div class="final-summary-title">إجمالي ضريبة السعر الفردي:</div>
                        <div class="final-summary-text" id="final-text-individual-tax">صفر ريال سعودي</div>
                    </div>
                    <div class="final-summary-value" id="final-total-individual-tax">0.00 ريال</div>
                </div>
                <div class="final-summary-item">
                    <div>
                        <div class="final-summary-title">إجمالي السعر غير شامل الضريبة:</div>
                        <div class="final-summary-text" id="final-text-excluding">صفر ريال سعودي</div>
                    </div>
                    <div class="final-summary-value" id="final-total-excluding">0.00 ريال</div>
                </div>
                <div class="final-summary-item">
                    <div>
                        <div class="final-summary-title">إجمالي ضريبة السعر الإجمالي:</div>
                        <div class="final-summary-text" id="final-text-tax">صفر ريال سعودي</div>
                    </div>
                    <div class="final-summary-value" id="final-total-tax">0.00 ريال</div>
                </div>
                <div class="final-summary-item grand-total-item">
                    <div>
                        <div class="final-summary-title">الإجمالي النهائي شامل الضريبة:</div>
                        <div class="final-summary-text" id="final-text-including">صفر ريال سعودي</div>
                    </div>
                    <div class="final-summary-value" id="final-total-including">0.00 ريال</div>
                </div>
                <div class="final-summary-item text-total-item">
                    <div class="final-summary-title">التفقيط للمبلغ النهائي:</div>
                    <div class="final-summary-text" id="final-text-total" style="font-size: 16px; font-weight: bold; color: #495057;">صفر ريال سعودي</div>
                </div>
            </div>
            <div class="instructions">
                <h3>مميزات الإصدار المطور:</h3>
                <ul>
                    <li><strong>حساب ضريبة السعر الإفرادي:</strong> يتم حساب الضريبة على السعر الإفرادي في جميع الأحوال</li>
                    <li><strong>السعر الإجمالي غير شامل:</strong> يظهر السعر الإجمالي قبل إضافة الضريبة</li>
                    <li><strong>السعر الإجمالي شامل:</strong> يظهر السعر الإجمالي بعد إضافة الضريبة</li>
                    <li><strong>تصميم محسن:</strong> واجهة أكثر جمالاً مع تدرجات لونية وتأثيرات بصرية</li>
                    <li><strong>حسابات متقدمة:</strong> نظام حساب أكثر دقة وشمولية</li>
                    <li><strong>تفقيط شامل:</strong> تحويل جميع المبالغ إلى كلمات عربية</li>
                </ul>
            </div>
            <input type="file" id="file-input" style="display: none;" accept=".xlsx, .xls">
        </div>
    </div>

    <!-- قائمة الاقتراحات -->
    <div id="suggestions" class="suggestions"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const table = document.getElementById('calculator-table');
            const tbody = table.querySelector('tbody');
            const addRowBtn = document.getElementById('add-row');
            const resetBtn = document.getElementById('reset');
            const exportBtn = document.getElementById('export-btn');
            const printBtn = document.getElementById('print-btn');
            const importBtn = document.getElementById('import-btn');
            const fileInput = document.getElementById('file-input');
            const settingsBtn = document.getElementById('settings-btn');
            const settingsPanel = document.getElementById('settings-panel');
            const yearsCountInput = document.getElementById('years-count');
            const applyYearsBtn = document.getElementById('apply-years');
            const globalTaxToggle = document.getElementById('global-tax-toggle');
            const taxRateInput = document.getElementById('tax-rate');
            let yearsCount = 3;
            let taxRate = 15;

            // --- نظام الاقتراحات من الإنترنت ---
            const suggestionsContainer = document.getElementById('suggestions');

            // ✅ دالة جلب الاقتراحات من Cloudflare Worker
            async function getPriceSuggestions(searchTerm, unit) {
                try {
                    // ⚠️ استبدل <اسم_مستخدمك> باسمك في Cloudflare
                    const response = await fetch(`https://price-api.<Amirelbarbari@gmail.com>.workers.dev?item=${encodeURIComponent(searchTerm)}&unit=${encodeURIComponent(unit)}`);
                    const data = await response.json();
                    if (data.error) return [];
                    return Array.isArray(data) ? data : [data];
                } catch (error) {
                    console.error("فشل في جلب السعر:", error);
                    return [];
                }
            }

            // عرض الاقتراحات
            function showSuggestions(suggestions, inputElement, nameInput, unitInput, priceInput) {
                suggestionsContainer.innerHTML = '';
                if (suggestions.length === 0) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }

                const rect = inputElement.getBoundingClientRect();
                suggestionsContainer.style.top = (rect.bottom + window.scrollY) + 'px';
                suggestionsContainer.style.right = (window.innerWidth - rect.right) + 'px';

                suggestions.forEach(suggestion => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.innerHTML = `
                        <div>
                            <div class="suggestion-name"><span class="ai-badge">AI</span> ${suggestion.name}</div>
                            <div class="suggestion-range">النطاق: ${suggestion.min} - ${suggestion.max} ر.س</div>
                            <div class="suggestion-source">${suggestion.source}</div>
                        </div>
                        <div class="suggestion-price">${suggestion.price} ر.س</div>
                    `;
                    div.addEventListener('click', () => {
                        const row = priceInput.closest('tr');
                        row.querySelector('.item-name').value = suggestion.name;
                        row.querySelector('.unit').value = suggestion.unit;
                        row.querySelector('.price').value = suggestion.price;
                        calculateRow(row);
                        calculateAll();
                        updateYearTotals();
                        suggestionsContainer.style.display = 'none';
                    });
                    suggestionsContainer.appendChild(div);
                });

                suggestionsContainer.style.display = 'block';
            }

            // ربط الاقتراحات بمدخل البند
            function setupSuggestions(row) {
                const nameInput = row.querySelector('.item-name');
                const unitInput = row.querySelector('.unit');
                const priceInput = row.querySelector('.price');

                nameInput.addEventListener('input', async function() {
                    if (this.value.trim().length > 1) {
                        const suggestions = await getPriceSuggestions(this.value, unitInput.value);
                        showSuggestions(suggestions, this, nameInput, unitInput, priceInput);
                    } else {
                        suggestionsContainer.style.display = 'none';
                    }
                });

                nameInput.addEventListener('blur', () => {
                    setTimeout(() => suggestionsContainer.style.display = 'none', 200);
                });
            }
            // --- نهاية نظام الاقتراحات ---

            // دالة تحويل الأرقام إلى كلمات عربية محسنة
            function Tafgeet(amount) {
                if (amount === 0) return 'صفر ريال سعودي';
                const parts = amount.toString().split('.');
                const wholePart = parseInt(parts[0]);
                const decimalPart = parts.length > 1 ? parseInt(parts[1].padEnd(2, '0').substring(0, 2)) : 0;
                const ones = ['', 'واحد', 'اثنان', 'ثلاثة', 'أربعة', 'خمسة', 'ستة', 'سبعة', 'ثمانية', 'تسعة',
                             'عشرة', 'أحد عشر', 'اثنا عشر', 'ثلاثة عشر', 'أربعة عشر', 'خمسة عشر', 
                             'ستة عشر', 'سبعة عشر', 'ثمانية عشر', 'تسعة عشر'];
                const tens = ['', '', 'عشرون', 'ثلاثون', 'أربعون', 'خمسون', 'ستون', 'سبعون', 'ثمانون', 'تسعون'];
                const hundreds = ['', 'مائة', 'مئتان', 'ثلاثمائة', 'أربعمائة', 'خمسمائة', 'ستمائة', 'سبعمائة', 'ثمانمائة', 'تسعمائة'];
                const units = ['', 'ألف', 'مليون', 'مليار'];
                function convertThreeDigits(num) {
                    let result = '';
                    const hundred = Math.floor(num / 100);
                    const remainder = num % 100;
                    if (hundred > 0) {
                        result += hundreds[hundred];
                        if (remainder > 0) result += ' و ';
                    }
                    if (remainder > 0) {
                        if (remainder < 20) {
                            result += ones[remainder];
                        } else {
                            const ten = Math.floor(remainder / 10);
                            const one = remainder % 10;
                            if (one > 0) result += ones[one] + ' و ';
                            result += tens[ten];
                        }
                    }
                    return result;
                }
                let result = '';
                let unitIndex = 0;
                let tempWhole = wholePart;
                while (tempWhole > 0) {
                    const threeDigits = tempWhole % 1000;
                    if (threeDigits > 0) {
                        let part = convertThreeDigits(threeDigits);
                        if (unitIndex > 0) part += ' ' + units[unitIndex];
                        result = result ? part + ' و ' + result : part;
                    }
                    tempWhole = Math.floor(tempWhole / 1000);
                    unitIndex++;
                }
                result += ' ريال سعودي';
                if (decimalPart > 0) {
                    result += ' و ' + convertThreeDigits(decimalPart) + ' هللة';
                }
                return result;
            }

            // إظهار/إخفاء لوحة الإعدادات
            settingsBtn.addEventListener('click', function() {
                settingsPanel.classList.toggle('active');
            });

            // تطبيق عدد السنوات
            applyYearsBtn.addEventListener('click', function() {
                yearsCount = parseInt(yearsCountInput.value) || 3;
                updateYearsColumns();
            });

            // تحديث نسبة الضريبة
            taxRateInput.addEventListener('input', function() {
                taxRate = parseFloat(this.value) || 15;
                calculateAll();
            });

            // إضافة صف جديد
            addRowBtn.addEventListener('click', function() {
                const newRow = document.createElement('tr');
                const rowCount = tbody.rows.length + 1;
                let yearInputs = '';
                for (let i = 1; i <= yearsCount; i++) {
                    yearInputs += `<td><input type="number" class="year${i}" min="0" value="" step="0.01"></td>`;
                }
                newRow.innerHTML = `
                    <td>${rowCount}</td>
                    <td><input type="text" class="item-name" placeholder="اسم البند"></td>
                    <td>
                        <select class="unit">
                            <option value="عدد">عدد</option>
                            <option value="حبة">حبة</option>
                            <option value="كيلو">كيلو</option>
                            <option value="لتر">لتر</option>
                            <option value="متر">متر</option>
                            <option value="علبة">علبة</option>
                        </select>
                    </td>
                    <td><input type="number" class="quantity" min="0" value="" step="0.01"></td>
                    ${yearInputs}
                    <td><input type="number" class="price" min="0" value="0" step="0.01"></td>
                    <td class="tax-toggle-cell">
                        <label class="switch">
                            <input type="checkbox" class="item-tax-toggle" ${globalTaxToggle.checked ? 'checked' : ''}>
                            <span class="slider"></span>
                        </label>
                    </td>
                    <td class="individual-tax">0.00</td>
                    <td class="total-price-excluding">0.00</td>
                    <td class="total-tax">0.00</td>
                    <td class="total-price-including">0.00</td>
                    <td><button class="delete-btn">X</button></td>
                `;
                tbody.appendChild(newRow);
                setupSuggestions(newRow);
                updateRowEvents();
                updateRowNumbers();
            });

            // تحديث أعمدة السنوات في الجدول
            function updateYearsColumns() {
                // تحديث الرأس
                const headerRow = table.querySelector('thead tr');
                // إزالة أعمدة السنوات الحالية
                const existingYearHeaders = headerRow.querySelectorAll('th:nth-child(n+5):nth-child(-n+7)');
                existingYearHeaders.forEach(header => header.remove());
                // إضافة أعمدة السنوات الجديدة
                const quantityHeader = headerRow.children[3];
                for (let i = 1; i <= yearsCount; i++) {
                    const yearHeader = document.createElement('th');
                    yearHeader.width = '6%';
                    yearHeader.textContent = `السنة ${i === 1 ? 'الأولى' : i === 2 ? 'الثانية' : i === 3 ? 'الثالثة' : i}`;
                    quantityHeader.after(yearHeader);
                }
                // تحديث الصفوف
                const rows = tbody.querySelectorAll('tr');
                rows.forEach(row => {
                    // إزالة خلايا السنوات الحالية
                    const existingYearCells = row.querySelectorAll('td:nth-child(n+5):nth-child(-n+7)');
                    existingYearCells.forEach(cell => cell.remove());
                    // إضافة خلايا السنوات الجديدة
                    const quantityCell = row.children[3];
                    for (let i = 1; i <= yearsCount; i++) {
                        const yearCell = document.createElement('td');
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.className = `year${i}`;
                        input.min = 0;
                        input.value = '';
                        input.step = 0.01;
                        yearCell.appendChild(input);
                        quantityCell.after(yearCell);
                    }
                });
                // تحديث التذييل
                const footerRow = table.querySelector('tfoot tr');
                const existingYearTotals = footerRow.querySelectorAll('td:nth-child(n+5):nth-child(-n+7)');
                existingYearTotals.forEach(cell => cell.remove());
                const totalQuantityCell = footerRow.children[3];
                for (let i = 1; i <= yearsCount; i++) {
                    const yearTotalCell = document.createElement('td');
                    yearTotalCell.id = `year${i}-total`;
                    yearTotalCell.textContent = '0.00';
                    totalQuantityCell.after(yearTotalCell);
                }
                updateRowEvents();
                calculateAll();
                updateYearTotals();
            }

            // تحديث أحداث الصفوف
            function updateRowEvents() {
                const rows = tbody.querySelectorAll('tr');
                rows.forEach(row => {
                    const inputs = row.querySelectorAll('input');
                    inputs.forEach(input => {
                        input.addEventListener('input', function() {
                            if (this.classList.contains('quantity') || this.classList.contains('price')) {
                                distributeQuantityToYears(row);
                            }
                            if (this.className.startsWith('year')) {
                                updateQuantityFromYears(row);
                            }
                            calculateRow(row);
                            updateYearTotals();
                        });
                    });
                    const taxToggle = row.querySelector('.item-tax-toggle');
                    if (taxToggle) {
                        taxToggle.addEventListener('change', function() {
                            calculateRow(row);
                        });
                    }
                    const deleteBtn = row.querySelector('.delete-btn');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', function() {
                            if (tbody.querySelectorAll('tr').length > 1) {
                                tbody.removeChild(row);
                                updateRowNumbers();
                                calculateAll();
                                updateYearTotals();
                            }
                        });
                    }
                });
            }

            // توزيع الكمية على السنوات
            function distributeQuantityToYears(row) {
                const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
                const equalShare = quantity / yearsCount;
                for (let i = 1; i <= yearsCount; i++) {
                    const yearInput = row.querySelector(`.year${i}`);
                    if (yearInput && !yearInput.value) {
                        yearInput.value = equalShare.toFixed(2);
                    }
                }
            }

            // تحديث الكمية من السنوات
            function updateQuantityFromYears(row) {
                let total = 0;
                for (let i = 1; i <= yearsCount; i++) {
                    const yearInput = row.querySelector(`.year${i}`);
                    if (yearInput && yearInput.value) {
                        total += parseFloat(yearInput.value) || 0;
                    }
                }
                row.querySelector('.quantity').value = total.toFixed(2);
            }

            // حساب صف واحد
            function calculateRow(row) {
                const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
                const price = parseFloat(row.querySelector('.price').value) || 0;
                const taxIncluded = row.querySelector('.item-tax-toggle').checked;
                // حساب ضريبة السعر الإفرادي (في جميع الأحوال)
                const individualTax = price * (taxRate / 100);
                // حساب السعر الإجمالي غير شامل الضريبة
                const totalPriceExcluding = quantity * price;
                // حساب ضريبة السعر الإجمالي
                const totalTax = totalPriceExcluding * (taxRate / 100);
                // حساب السعر الإجمالي شامل الضريبة
                const totalPriceIncluding = totalPriceExcluding + totalTax;
                // تحديث الخلايا
                row.querySelector('.individual-tax').textContent = individualTax.toFixed(2);
                row.querySelector('.total-price-excluding').textContent = totalPriceExcluding.toFixed(2);
                row.querySelector('.total-tax').textContent = totalTax.toFixed(2);
                row.querySelector('.total-price-including').textContent = totalPriceIncluding.toFixed(2);
                calculateAll();
            }

            // حساب جميع القيم
            function calculateAll() {
                let totalQuantity = 0;
                let totalIndividualTax = 0;
                let totalPriceExcluding = 0;
                let totalTax = 0;
                let totalPriceIncluding = 0;
                const rows = tbody.querySelectorAll('tr');
                rows.forEach(row => {
                    totalQuantity += parseFloat(row.querySelector('.quantity').value) || 0;
                    totalIndividualTax += parseFloat(row.querySelector('.individual-tax').textContent) || 0;
                    totalPriceExcluding += parseFloat(row.querySelector('.total-price-excluding').textContent) || 0;
                    totalTax += parseFloat(row.querySelector('.total-tax').textContent) || 0;
                    totalPriceIncluding += parseFloat(row.querySelector('.total-price-including').textContent) || 0;
                });
                // تحديث التذييل
                document.getElementById('total-quantity').textContent = totalQuantity.toFixed(2);
                document.getElementById('total-individual-tax').textContent = totalIndividualTax.toFixed(2);
                document.getElementById('total-price-excluding').textContent = totalPriceExcluding.toFixed(2);
                document.getElementById('total-tax').textContent = totalTax.toFixed(2);
                document.getElementById('total-price-including').textContent = totalPriceIncluding.toFixed(2);
                // تحديث الملخص النهائي
                document.getElementById('final-total-quantity').textContent = totalQuantity.toFixed(2);
                document.getElementById('final-total-individual-tax').textContent = totalIndividualTax.toFixed(2) + ' ريال';
                document.getElementById('final-total-excluding').textContent = totalPriceExcluding.toFixed(2) + ' ريال';
                document.getElementById('final-total-tax').textContent = totalTax.toFixed(2) + ' ريال';
                document.getElementById('final-total-including').textContent = totalPriceIncluding.toFixed(2) + ' ريال';
                // تحديث التفقيط
                document.getElementById('final-text-quantity').textContent = Tafgeet(totalQuantity).replace(' ريال سعودي', '');
                document.getElementById('final-text-individual-tax').textContent = Tafgeet(totalIndividualTax);
                document.getElementById('final-text-excluding').textContent = Tafgeet(totalPriceExcluding);
                document.getElementById('final-text-tax').textContent = Tafgeet(totalTax);
                document.getElementById('final-text-including').textContent = Tafgeet(totalPriceIncluding);
                document.getElementById('final-text-total').textContent = Tafgeet(totalPriceIncluding);
            }

            // تحديث مجاميع السنوات
            function updateYearTotals() {
                for (let i = 1; i <= yearsCount; i++) {
                    let yearTotal = 0;
                    const rows = tbody.querySelectorAll('tr');
                    rows.forEach(row => {
                        const yearInput = row.querySelector(`.year${i}`);
                        if (yearInput) {
                            yearTotal += parseFloat(yearInput.value) || 0;
                        }
                    });
                    const yearTotalElement = document.getElementById(`year${i}-total`);
                    if (yearTotalElement) {
                        yearTotalElement.textContent = yearTotal.toFixed(2);
                    }
                }
            }

            // تحديث أرقام الصفوف
            function updateRowNumbers() {
                const rows = tbody.querySelectorAll('tr');
                rows.forEach((row, index) => {
                    row.cells[0].textContent = index + 1;
                });
            }

            // إعادة تعيين الجدول
            resetBtn.addEventListener('click', function() {
                if (confirm("هل أنت متأكد من أنك تريد مسح جميع البنود؟")) {
                    tbody.innerHTML = '';
                    document.getElementById('project-name').value = '';
                    addRowBtn.click();
                    calculateAll();
                    updateYearTotals();
                }
            });

            // تصدير إلى Excel
            exportBtn.addEventListener('click', function() {
                const projectName = document.getElementById('project-name').value || 'مشروع بدون اسم';
                const data = [];
                data.push([projectName]);
                data.push([]);
                const headers = ['حذف', 'السعر الإجمالي شامل', 'ضريبة السعر الإجمالي', 'السعر الإجمالي غير شامل', 'ضريبة السعر الفردي', 'ضريبة', 'السعر الإفرادي'];
                for (let i = yearsCount; i >= 1; i--) {
                    headers.push(`السنة ${i}`);
                }
                headers.push('الكمية الإجمالية', 'وحدة القياس', 'البند', 'م');
                data.push(headers);
                const rows = tbody.querySelectorAll('tr');
                rows.forEach((row, index) => {
                    const rowData = [
                        '',
                        parseFloat(row.querySelector('.total-price-including').textContent) || 0,
                        parseFloat(row.querySelector('.total-tax').textContent) || 0,
                        parseFloat(row.querySelector('.total-price-excluding').textContent) || 0,
                        parseFloat(row.querySelector('.individual-tax').textContent) || 0,
                        row.querySelector('.item-tax-toggle').checked ? 'نعم' : 'لا',
                        parseFloat(row.querySelector('.price').value) || 0,
                    ];
                    for (let i = yearsCount; i >= 1; i--) {
                        const yearInput = row.querySelector(`.year${i}`);
                        rowData.push(parseFloat(yearInput?.value) || 0);
                    }
                    rowData.push(
                        parseFloat(row.querySelector('.quantity').value) || 0,
                        row.querySelector('.unit').value,
                        row.querySelector('.item-name').value,
                        index + 1
                    );
                    data.push(rowData);
                });
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'جدول الكميات');
                XLSX.writeFile(wb, `${projectName}.xlsx`);
            });

            // استيراد من Excel
            importBtn.addEventListener('click', function() {
                fileInput.click();
            });

            // طباعة
            printBtn.addEventListener('click', function() {
                window.print();
            });

            // التهيئة الأولية
            updateRowEvents();
            calculateAll();
            updateYearTotals();

            // إعداد الاقتراح